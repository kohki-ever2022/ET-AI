# ET-AI ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£æˆ¦ç•¥

## ğŸ“‹ ç›®æ¬¡

- [æ¦‚è¦](#æ¦‚è¦)
- [ç¾åœ¨ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ†æ](#ç¾åœ¨ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ†æ)
- [ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥](#ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥)
- [ã‚³ã‚¹ãƒˆäºˆæ¸¬](#ã‚³ã‚¹ãƒˆäºˆæ¸¬)
- [ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ†æã¨å¯¾ç­–](#ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ†æã¨å¯¾ç­–)
- [å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º](#å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º)
- [ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æˆ¦ç•¥](#ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æˆ¦ç•¥)

---

## æ¦‚è¦

ET-AIã‚·ã‚¹ãƒ†ãƒ ã‚’**10ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ 50ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ 100ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã«ã‚¹ã‚±ãƒ¼ãƒ«ã™ã‚‹éš›ã®åŒ…æ‹¬çš„ãªæˆ¦ç•¥ã‚’å®šç¾©ã—ã¾ã™ã€‚

### ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ç›®æ¨™

| æ®µéš | ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•° | æƒ³å®šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•° | æœˆé–“ãƒãƒ£ãƒƒãƒˆæ•° | é”æˆæ™‚æœŸ |
|------|-----------|------------------|--------------|---------|
| **Phase 1ï¼ˆç¾åœ¨ï¼‰** | 10 | 20 | 2,000 | 2025 Q1 |
| **Phase 2** | 50 | 100 | 10,000 | 2025 Q2 |
| **Phase 3** | 100 | 200 | 20,000 | 2025 Q3-Q4 |

### ä¸»è¦ãªèª²é¡Œ

1. **Claude APIã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: 50ãƒ¦ãƒ¼ã‚¶ãƒ¼æ™‚ã«åˆ¶é™ã«åˆ°é”ã™ã‚‹ãƒªã‚¹ã‚¯
2. **Firestoreã®ã‚³ã‚¹ãƒˆå¢—åŠ **: 100ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§æœˆé–“èª­ã¿å–ã‚Š500ä¸‡å›ã‚’è¶…ãˆã‚‹å¯èƒ½æ€§
3. **Cloud Functionsã®åŒæ™‚å®Ÿè¡Œ**: ãƒ”ãƒ¼ã‚¯æ™‚ã®åŒæ™‚å®Ÿè¡Œæ•°ãŒåˆ¶é™ã«é”ã™ã‚‹
4. **Vector Searchã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚º**: 100ä¸‡ãƒãƒ£ãƒ³ã‚¯åˆ°é”æ™‚ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹

---

## ç¾åœ¨ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ†æ

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ                          â”‚
â”‚              (React + Firebase SDK)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                         â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Firebase  â”‚         â”‚ Cloud         â”‚
â”‚  Hosting   â”‚         â”‚ Functions     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                           â”‚       â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                               â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   Firestore    â”‚            â”‚  External APIs  â”‚
      â”‚   Database     â”‚            â”‚  - Claude API   â”‚
      â”‚                â”‚            â”‚  - Voyage AI    â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¾åœ¨ã®ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨çŠ¶æ³ï¼ˆ10ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ³å®šï¼‰

#### Cloud Functions

| é–¢æ•°å | ãƒ¡ãƒ¢ãƒª | ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | æœˆé–“å®Ÿè¡Œå›æ•° | å®Ÿè¡Œæ™‚é–“å¹³å‡ |
|--------|--------|------------|------------|------------|
| `processFileUpload` | 1GB | 540s | 200 | 45s |
| `vectorSearch` | 512MB | 60s | 4,000 | 2s |
| `processChat` | 1GB | 300s | 2,000 | 15s |
| `generateEmbeddings` | 512MB | 120s | 800 | 8s |

**åˆè¨ˆã‚³ã‚¹ãƒˆ**: ç´„ $15/æœˆ

#### Firestore

| æ“ä½œ | æœˆé–“å›æ•°ï¼ˆ10ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ | ã‚³ã‚¹ãƒˆ |
|------|---------------------|--------|
| èª­ã¿å–ã‚Š | 500,000 | $0.18 |
| æ›¸ãè¾¼ã¿ | 50,000 | $0.90 |
| å‰Šé™¤ | 5,000 | $0.09 |
| ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ (10GB) | - | $1.80 |

**åˆè¨ˆã‚³ã‚¹ãƒˆ**: ç´„ $3/æœˆ

#### Claude APIï¼ˆ3å±¤ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æœ‰åŠ¹ï¼‰

| ãƒˆãƒ¼ã‚¯ãƒ³ã‚¿ã‚¤ãƒ— | æœˆé–“ãƒˆãƒ¼ã‚¯ãƒ³æ•° | å˜ä¾¡ | ã‚³ã‚¹ãƒˆ |
|--------------|--------------|------|--------|
| Inputï¼ˆé€šå¸¸ï¼‰ | 5M | $3/M | $15.00 |
| Cache Write | 3M | $3.75/M | $11.25 |
| Cache Read | 45M | $0.30/M | $13.50 |
| Output | 4M | $15/M | $60.00 |

**ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—æƒ³å®šã‚³ã‚¹ãƒˆ**: $150/æœˆ
**3å±¤ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°é©ç”¨å¾Œ**: $99.75/æœˆ
**ã‚³ã‚¹ãƒˆå‰Šæ¸›ç‡**: 33.5%

#### Voyage AIï¼ˆEmbedding APIï¼‰

| æ“ä½œ | æœˆé–“ãƒˆãƒ¼ã‚¯ãƒ³æ•° | å˜ä¾¡ | ã‚³ã‚¹ãƒˆ |
|------|--------------|------|--------|
| voyage-3 (1024æ¬¡å…ƒ) | 2M | $0.06/M | $0.12 |

**åˆè¨ˆã‚³ã‚¹ãƒˆ**: ç´„ $0.12/æœˆ

### ç¾åœ¨ã®åˆè¨ˆæœˆé–“ã‚³ã‚¹ãƒˆ: **ç´„ $118/æœˆ**

---

## ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥

### Phase 2: 50ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ

#### 1. Cloud Functions ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°

##### åŒæ™‚å®Ÿè¡Œåˆ¶é™ã®èª¿æ•´

**ç¾åœ¨ã®è¨­å®š**:
```typescript
// functions/src/index.ts
export const processChat = functions
  .runWith({
    memory: '1GB',
    timeoutSeconds: 300,
    maxInstances: 10, // â† ç¾åœ¨
  })
  .https.onCall(async (data, context) => {
    // ...
  });
```

**50ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘è¨­å®š**:
```typescript
export const processChat = functions
  .runWith({
    memory: '1GB',
    timeoutSeconds: 300,
    maxInstances: 30, // 10 â†’ 30 ã«å¢—åŠ 
    minInstances: 2,  // ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆé˜²æ­¢
  })
  .https.onCall(async (data, context) => {
    // ...
  });
```

**èª¿æ•´å†…å®¹**:

| é–¢æ•° | ç¾åœ¨ã®maxInstances | 50ãƒ¦ãƒ¼ã‚¶ãƒ¼æ™‚ | 100ãƒ¦ãƒ¼ã‚¶ãƒ¼æ™‚ |
|------|------------------|------------|--------------|
| `processChat` | 10 | 30 | 60 |
| `vectorSearch` | 10 | 50 | 100 |
| `processFileUpload` | 5 | 15 | 30 |
| `generateEmbeddings` | 10 | 30 | 60 |

**minInstancesè¿½åŠ ã«ã‚ˆã‚‹ãƒ¡ãƒªãƒƒãƒˆ**:
- ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚é–“: 3-5ç§’ â†’ 0ç§’
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã®å®‰å®šåŒ–
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å‘ä¸Š

**è¿½åŠ ã‚³ã‚¹ãƒˆ**:
- minInstances=2ï¼ˆå¸¸æ™‚èµ·å‹•ï¼‰: ç´„ $10/æœˆ Ã— 2é–¢æ•° = $20/æœˆ

##### ãƒ¡ãƒ¢ãƒªæœ€é©åŒ–

**processFileUpload ã®æœ€é©åŒ–**:
```typescript
// å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ç”¨
export const processFileUpload = functions
  .runWith({
    memory: '2GB', // 1GB â†’ 2GBï¼ˆå¤§å®¹é‡PDFå¯¾å¿œï¼‰
    timeoutSeconds: 540,
    maxInstances: 15,
  })
  .https.onCall(async (data, context) => {
    // ...
  });
```

#### 2. Firestore ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°

##### èª­ã¿å–ã‚Šæœ€é©åŒ–æˆ¦ç•¥

**ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°éšå±¤ã®å°å…¥**:

```typescript
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆReact Queryï¼‰
import { useQuery } from '@tanstack/react-query';

export function useProjectData(projectId: string) {
  return useQuery({
    queryKey: ['project', projectId],
    queryFn: () => fetchProject(projectId),
    staleTime: 5 * 60 * 1000, // 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    cacheTime: 30 * 60 * 1000, // 30åˆ†é–“ä¿æŒ
  });
}
```

**åŠ¹æœ**:
- é‡è¤‡èª­ã¿å–ã‚Šã‚’70%å‰Šæ¸›
- 500,000èª­ã¿å–ã‚Š â†’ 150,000èª­ã¿å–ã‚Š
- ã‚³ã‚¹ãƒˆå‰Šæ¸›: $0.18 â†’ $0.05/æœˆ

##### Firebaseãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ‰åŠ¹åŒ–

```typescript
// config/firebase.ts
import { initializeFirestore, persistentLocalCache } from 'firebase/firestore';

export const db = initializeFirestore(app, {
  localCache: persistentLocalCache(),
});
```

**åŠ¹æœ**:
- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ
- èª­ã¿å–ã‚Šå›æ•°50%å‰Šæ¸›
- ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚é–“ã®çŸ­ç¸®

##### ãƒãƒƒãƒèª­ã¿å–ã‚Šã®æœ€é©åŒ–

**ç¾åœ¨ã®å®Ÿè£…**:
```typescript
// éåŠ¹ç‡: N+1ã‚¯ã‚¨ãƒª
for (const chat of chats) {
  const user = await getDoc(doc(db, 'users', chat.userId));
  const project = await getDoc(doc(db, 'projects', chat.projectId));
}
// èª­ã¿å–ã‚Šå›æ•°: chats.length Ã— 2
```

**æœ€é©åŒ–å¾Œ**:
```typescript
// åŠ¹ç‡çš„: ãƒãƒƒãƒå–å¾—
const userIds = [...new Set(chats.map(c => c.userId))];
const projectIds = [...new Set(chats.map(c => c.projectId))];

const [users, projects] = await Promise.all([
  getMultipleDocs(db, 'users', userIds),
  getMultipleDocs(db, 'projects', projectIds),
]);
// èª­ã¿å–ã‚Šå›æ•°: userIds.length + projectIds.length
```

**åŠ¹æœ**: èª­ã¿å–ã‚Šå›æ•°ã‚’æœ€å¤§80%å‰Šæ¸›

##### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–

**è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¿½åŠ **:
```json
// firestore.indexes.json
{
  "indexes": [
    {
      "collectionGroup": "chats",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "projectId", "order": "ASCENDING" },
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "knowledge",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "projectId", "order": "ASCENDING" },
        { "fieldPath": "category", "order": "ASCENDING" },
        { "fieldPath": "embedding", "order": "ASCENDING" }
      ]
    }
  ]
}
```

#### 3. Claude API ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–

##### ç¾åœ¨ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆTier 2æƒ³å®šï¼‰

| åˆ¶é™ã‚¿ã‚¤ãƒ— | åˆ¶é™å€¤ | ç¾åœ¨ã®ä½¿ç”¨ç‡ | 50ãƒ¦ãƒ¼ã‚¶ãƒ¼æ™‚ | 100ãƒ¦ãƒ¼ã‚¶ãƒ¼æ™‚ |
|----------|--------|------------|------------|--------------|
| RPMï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ/åˆ†ï¼‰ | 50 | 10% (5 RPM) | 60% (30 RPM) | 120% (60 RPM) âš ï¸ |
| TPMï¼ˆãƒˆãƒ¼ã‚¯ãƒ³/åˆ†ï¼‰ | 40,000 | 20% (8K TPM) | 75% (30K TPM) | 150% (60K TPM) âš ï¸ |
| RPDï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ—¥ï¼‰ | 50,000 | 5% (2,500) | 20% (10,000) | 40% (20,000) |

##### å¯¾ç­–1: ã‚­ãƒ¥ãƒ¼åˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…

**queueService.ts ã®æ‹¡å¼µ**:
```typescript
// functions/src/services/queueService.ts

interface QueueConfig {
  maxConcurrent: number;  // åŒæ™‚å®Ÿè¡Œæ•°
  rateLimitRPM: number;   // RPMåˆ¶é™
  retryAttempts: number;  // ãƒªãƒˆãƒ©ã‚¤å›æ•°
  retryDelay: number;     // ãƒªãƒˆãƒ©ã‚¤é…å»¶ï¼ˆmsï¼‰
}

const CLAUDE_QUEUE_CONFIG: QueueConfig = {
  maxConcurrent: 25,      // 50 RPMåˆ¶é™ã®50%ã«æŠ‘ãˆã‚‹
  rateLimitRPM: 25,       // APIãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®50%
  retryAttempts: 3,
  retryDelay: 2000,
};

export class ClaudeRequestQueue {
  private queue: Array<QueuedRequest> = [];
  private processing = 0;
  private lastMinute: number[] = [];

  async enqueue(request: ClaudeAPIRequest): Promise<ClaudeAPIResponse> {
    // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
    this.cleanOldTimestamps();

    if (this.lastMinute.length >= CLAUDE_QUEUE_CONFIG.rateLimitRPM) {
      // å¾…æ©Ÿæ™‚é–“ã‚’è¨ˆç®—
      const oldestTimestamp = this.lastMinute[0];
      const waitTime = 60000 - (Date.now() - oldestTimestamp);

      if (waitTime > 0) {
        await new Promise(resolve => setTimeout(resolve, waitTime));
      }
    }

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†
    this.lastMinute.push(Date.now());
    return this.processRequest(request);
  }

  private cleanOldTimestamps() {
    const oneMinuteAgo = Date.now() - 60000;
    this.lastMinute = this.lastMinute.filter(ts => ts > oneMinuteAgo);
  }
}
```

##### å¯¾ç­–2: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ã®æœ€é©åŒ–

**ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡ã®å‘ä¸Š**:

ç¾åœ¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡:
- ç¬¬1å±¤ï¼ˆã‚³ã‚¢åˆ¶ç´„ï¼‰: 100%
- ç¬¬2å±¤ï¼ˆIRå°‚é–€çŸ¥è­˜ï¼‰: 95%
- ç¬¬3å±¤ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ï¼‰: 70%

**ç›®æ¨™**: ç¬¬3å±¤ã®ãƒ’ãƒƒãƒˆç‡ã‚’70% â†’ 85%ã«å‘ä¸Š

**å®Ÿè£…**:
```typescript
// services/claudeService.ts

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒŠãƒ¬ãƒƒã‚¸ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ç”Ÿæˆ
function generateKnowledgeCacheKey(projectId: string, queryText: string): string {
  // ã‚¯ã‚¨ãƒªã®æ„å‘³çš„é¡ä¼¼æ€§ã‚’è€ƒæ…®ã—ãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼
  const normalizedQuery = normalizeQuery(queryText);
  const semanticHash = hashSemanticContent(normalizedQuery);
  return `${projectId}:${semanticHash}`;
}

// é¡ä¼¼ã‚¯ã‚¨ãƒªã®æ¤œå‡ºã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†åˆ©ç”¨
async function getCachedKnowledge(
  cacheKey: string
): Promise<Knowledge[] | null> {
  const cached = await redis.get(cacheKey);
  if (cached) {
    return JSON.parse(cached);
  }
  return null;
}
```

**åŠ¹æœ**:
- ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»é‡: 15%å‰Šæ¸›
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: 30%çŸ­ç¸®
- ã‚³ã‚¹ãƒˆå‰Šæ¸›: $15/æœˆ

##### å¯¾ç­–3: Tier 3ã¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ¤œè¨

**Tier 3ã®åˆ¶é™å€¤**:
- RPM: 1,000ï¼ˆ20å€ï¼‰
- TPM: 80,000ï¼ˆ2å€ï¼‰
- RPD: 300,000ï¼ˆ6å€ï¼‰

**ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ¡ä»¶**:
- 50ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ°é”æ™‚ç‚¹ã§æ¤œè¨
- æœˆé–“åˆ©ç”¨é¡ãŒ$1,000ã‚’è¶…ãˆã‚‹å ´åˆ

**ç”³è«‹æ–¹æ³•**: Anthropic ã‚µãƒãƒ¼ãƒˆã«é€£çµ¡

#### 4. Vector Search ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°

##### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚ºã®ç®¡ç†

**ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚ºäºˆæ¸¬**:

| ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•° | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•° | ãƒŠãƒ¬ãƒƒã‚¸ä»¶æ•° | Embeddingæ•° | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚º |
|----------|--------------|------------|------------|-----------------|
| 10 | 20 | 10,000 | 50,000 | 200MB |
| 50 | 100 | 50,000 | 250,000 | 1GB |
| 100 | 200 | 100,000 | 500,000 | 2GB |

##### æœ€é©åŒ–æˆ¦ç•¥

**1. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°**:
```typescript
// functions/src/services/vectorSearchService.ts

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’åˆ†å‰²
async function searchInPartitionedIndex(
  projectId: string,
  queryEmbedding: number[],
  limit: number
): Promise<SearchResult[]> {
  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¤œç´¢
  const results = await db
    .collection('knowledge')
    .where('projectId', '==', projectId)
    .where('embedding', '!=', null)
    .get();

  // ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦è¨ˆç®—
  const scored = results.docs.map(doc => {
    const data = doc.data();
    const similarity = calculateCosineSimilarity(
      queryEmbedding,
      data.embedding
    );
    return { doc, similarity };
  });

  // ä¸Šä½Nä»¶ã‚’è¿”ã™
  return scored
    .sort((a, b) => b.similarity - a.similarity)
    .slice(0, limit);
}
```

**2. å¤ã„ãƒŠãƒ¬ãƒƒã‚¸ã®è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–**:
```typescript
// functions/src/scheduledArchiveOldKnowledge.ts

export const archiveOldKnowledge = onSchedule('every 7 days', async () => {
  const sixMonthsAgo = new Date();
  sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);

  const oldKnowledge = await db
    .collection('knowledge')
    .where('lastAccessedAt', '<', sixMonthsAgo)
    .where('isArchived', '==', false)
    .limit(1000)
    .get();

  const batch = db.batch();
  oldKnowledge.docs.forEach(doc => {
    batch.update(doc.ref, {
      isArchived: true,
      archivedAt: serverTimestamp(),
      embedding: admin.firestore.FieldValue.delete(), // Embeddingã‚’å‰Šé™¤
    });
  });

  await batch.commit();
  console.log(`Archived ${oldKnowledge.size} knowledge entries`);
});
```

**åŠ¹æœ**:
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚º: 30%å‰Šæ¸›
- æ¤œç´¢é€Ÿåº¦: 40%å‘ä¸Š
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆ: 20%å‰Šæ¸›

##### Voyage AI ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–

**ç¾åœ¨ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™**:
- RPM: 300
- TPM: 1,000,000

**50ãƒ¦ãƒ¼ã‚¶ãƒ¼æ™‚ã®äºˆæ¸¬ä½¿ç”¨ç‡**:
- RPM: 150 (50%)
- TPM: 300,000 (30%)

**å¯¾ç­–**: ç¾åœ¨ã®åˆ¶é™ã§ååˆ†å¯¾å¿œå¯èƒ½

---

## ã‚³ã‚¹ãƒˆäºˆæ¸¬

### Phase 2: 50ãƒ¦ãƒ¼ã‚¶ãƒ¼æ™‚ã®ã‚³ã‚¹ãƒˆ

#### Cloud Functions

| é–¢æ•° | å®Ÿè¡Œå›æ•°/æœˆ | å®Ÿè¡Œæ™‚é–“ | ãƒ¡ãƒ¢ãƒª | ã‚³ã‚¹ãƒˆ |
|------|-----------|---------|--------|--------|
| `processChat` | 10,000 | 15s | 1GB | $30 |
| `vectorSearch` | 20,000 | 2s | 512MB | $8 |
| `processFileUpload` | 1,000 | 45s | 2GB | $18 |
| `generateEmbeddings` | 4,000 | 8s | 512MB | $6 |
| minInstances (å¸¸æ™‚èµ·å‹•) | - | - | - | $20 |

**åˆè¨ˆ**: $82/æœˆ

#### Firestore

| æ“ä½œ | æœˆé–“å›æ•° | å˜ä¾¡ | ã‚³ã‚¹ãƒˆ |
|------|---------|------|--------|
| èª­ã¿å–ã‚Šï¼ˆæœ€é©åŒ–å¾Œï¼‰ | 1,500,000 | $0.36/M | $0.54 |
| æ›¸ãè¾¼ã¿ | 250,000 | $1.80/M | $4.50 |
| å‰Šé™¤ | 25,000 | $0.18/M | $0.45 |
| ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ (50GB) | - | $0.18/GB | $9.00 |

**åˆè¨ˆ**: $14.49/æœˆ

#### Claude APIï¼ˆ3å±¤ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ï¼‰

| ãƒˆãƒ¼ã‚¯ãƒ³ã‚¿ã‚¤ãƒ— | æœˆé–“ãƒˆãƒ¼ã‚¯ãƒ³æ•° | å˜ä¾¡ | ã‚³ã‚¹ãƒˆ |
|--------------|--------------|------|--------|
| Inputï¼ˆé€šå¸¸ï¼‰ | 25M | $3/M | $75 |
| Cache Write | 15M | $3.75/M | $56.25 |
| Cache Read | 225M | $0.30/M | $67.50 |
| Output | 20M | $15/M | $300 |

**åˆè¨ˆ**: $498.75/æœˆ

**ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—æƒ³å®š**: $750/æœˆ
**å‰Šæ¸›ç‡**: 33.5%

#### Voyage AI

| æ“ä½œ | æœˆé–“ãƒˆãƒ¼ã‚¯ãƒ³æ•° | å˜ä¾¡ | ã‚³ã‚¹ãƒˆ |
|------|--------------|------|--------|
| voyage-3 | 10M | $0.06/M | $0.60 |

**åˆè¨ˆ**: $0.60/æœˆ

#### ãã®ä»–ã®ã‚³ã‚¹ãƒˆ

| ã‚µãƒ¼ãƒ“ã‚¹ | ã‚³ã‚¹ãƒˆ |
|---------|--------|
| Firebase Hosting | $5/æœˆ |
| Firebase Storage | $5/æœˆ |
| Cloud Logging | $3/æœˆ |

**åˆè¨ˆ**: $13/æœˆ

### **50ãƒ¦ãƒ¼ã‚¶ãƒ¼æ™‚ã®åˆè¨ˆæœˆé–“ã‚³ã‚¹ãƒˆ: $608.84/æœˆ**

**1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ãŸã‚Š**: $12.18/æœˆ

---

### Phase 3: 100ãƒ¦ãƒ¼ã‚¶ãƒ¼æ™‚ã®ã‚³ã‚¹ãƒˆ

#### Cloud Functions

| é–¢æ•° | å®Ÿè¡Œå›æ•°/æœˆ | å®Ÿè¡Œæ™‚é–“ | ãƒ¡ãƒ¢ãƒª | ã‚³ã‚¹ãƒˆ |
|------|-----------|---------|--------|--------|
| `processChat` | 20,000 | 15s | 1GB | $60 |
| `vectorSearch` | 40,000 | 2s | 512MB | $16 |
| `processFileUpload` | 2,000 | 45s | 2GB | $36 |
| `generateEmbeddings` | 8,000 | 8s | 512MB | $12 |
| minInstances (å¸¸æ™‚èµ·å‹•) | - | - | - | $40 |

**åˆè¨ˆ**: $164/æœˆ

#### Firestore

| æ“ä½œ | æœˆé–“å›æ•° | å˜ä¾¡ | ã‚³ã‚¹ãƒˆ |
|------|---------|------|--------|
| èª­ã¿å–ã‚Šï¼ˆæœ€é©åŒ–å¾Œï¼‰ | 3,000,000 | $0.36/M | $1.08 |
| æ›¸ãè¾¼ã¿ | 500,000 | $1.80/M | $9.00 |
| å‰Šé™¤ | 50,000 | $0.18/M | $0.90 |
| ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ (100GB) | - | $0.18/GB | $18.00 |

**åˆè¨ˆ**: $28.98/æœˆ

#### Claude APIï¼ˆ3å±¤ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚° + Tier 3ï¼‰

| ãƒˆãƒ¼ã‚¯ãƒ³ã‚¿ã‚¤ãƒ— | æœˆé–“ãƒˆãƒ¼ã‚¯ãƒ³æ•° | å˜ä¾¡ | ã‚³ã‚¹ãƒˆ |
|--------------|--------------|------|--------|
| Inputï¼ˆé€šå¸¸ï¼‰ | 50M | $3/M | $150 |
| Cache Write | 30M | $3.75/M | $112.50 |
| Cache Read | 450M | $0.30/M | $135.00 |
| Output | 40M | $15/M | $600 |

**åˆè¨ˆ**: $997.50/æœˆ

**ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—æƒ³å®š**: $1,500/æœˆ
**å‰Šæ¸›ç‡**: 33.5%

#### Voyage AI

| æ“ä½œ | æœˆé–“ãƒˆãƒ¼ã‚¯ãƒ³æ•° | å˜ä¾¡ | ã‚³ã‚¹ãƒˆ |
|------|--------------|------|--------|
| voyage-3 | 20M | $0.06/M | $1.20 |

**åˆè¨ˆ**: $1.20/æœˆ

#### ãã®ä»–ã®ã‚³ã‚¹ãƒˆ

| ã‚µãƒ¼ãƒ“ã‚¹ | ã‚³ã‚¹ãƒˆ |
|---------|--------|
| Firebase Hosting | $10/æœˆ |
| Firebase Storage | $10/æœˆ |
| Cloud Logging | $6/æœˆ |

**åˆè¨ˆ**: $26/æœˆ

### **100ãƒ¦ãƒ¼ã‚¶ãƒ¼æ™‚ã®åˆè¨ˆæœˆé–“ã‚³ã‚¹ãƒˆ: $1,217.68/æœˆ**

**1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ãŸã‚Š**: $12.18/æœˆ

---

### ã‚³ã‚¹ãƒˆæ¯”è¼ƒã‚µãƒãƒªãƒ¼

| é …ç›® | 10ãƒ¦ãƒ¼ã‚¶ãƒ¼ | 50ãƒ¦ãƒ¼ã‚¶ãƒ¼ | 100ãƒ¦ãƒ¼ã‚¶ãƒ¼ | ã‚¹ã‚±ãƒ¼ãƒ«åŠ¹ç‡ |
|------|----------|----------|-----------|------------|
| **åˆè¨ˆã‚³ã‚¹ãƒˆ** | $118/æœˆ | $609/æœˆ | $1,218/æœˆ | ç·šå½¢ |
| **ãƒ¦ãƒ¼ã‚¶ãƒ¼å˜ä¾¡** | $11.80 | $12.18 | $12.18 | å®‰å®š |
| **Claude API** | $100 (85%) | $499 (82%) | $998 (82%) | ä¸»è¦ã‚³ã‚¹ãƒˆ |
| **Infrastructure** | $18 (15%) | $110 (18%) | $220 (18%) | æ¯”ä¾‹å¢—åŠ  |

**é‡è¦ãªæ´å¯Ÿ**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å˜ä¾¡ã¯å®‰å®šï¼ˆ$11.80 â†’ $12.18ï¼‰
- Claude APIãŒå…¨ä½“ã®80%ä»¥ä¸Šã‚’å ã‚ã‚‹
- ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ã‚¹ãƒˆã¯ã»ã¼ç·šå½¢ã«ã‚¹ã‚±ãƒ¼ãƒ«
- 3å±¤ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ã§33.5%ã®ã‚³ã‚¹ãƒˆå‰Šæ¸›ã‚’ç¶­æŒ

---

## ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ†æã¨å¯¾ç­–

### ãƒœãƒˆãƒ«ãƒãƒƒã‚¯1: Claude API ãƒ¬ãƒ¼ãƒˆåˆ¶é™

#### å•é¡Œ

**50ãƒ¦ãƒ¼ã‚¶ãƒ¼æ™‚**:
- ãƒ”ãƒ¼ã‚¯æ™‚RPM: 30 (åˆ¶é™ã®60%)
- é€šå¸¸æ™‚ã¯å•é¡Œãªã—
- ã‚¤ãƒ™ãƒ³ãƒˆæ™‚ï¼ˆçµ±åˆå ±å‘Šæ›¸ç· åˆ‡æ—¥ï¼‰ã«åˆ¶é™åˆ°é”ãƒªã‚¹ã‚¯

**100ãƒ¦ãƒ¼ã‚¶ãƒ¼æ™‚**:
- ãƒ”ãƒ¼ã‚¯æ™‚RPM: 60 (åˆ¶é™ã®120%) âš ï¸ **åˆ¶é™è¶…é**
- ç¢ºå®Ÿã«åˆ¶é™ã«åˆ°é”

#### å½±éŸ¿åº¦

- **å„ªå…ˆåº¦**: ğŸ”´ Critical
- **ç™ºç”Ÿç¢ºç‡**: 100ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ç¢ºå®Ÿã«ç™ºç”Ÿ
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼å½±éŸ¿**: ãƒãƒ£ãƒƒãƒˆé€ä¿¡å¤±æ•—ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

#### å¯¾ç­–

**1. ã‚­ãƒ¥ãƒ¼åˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå¿…é ˆï¼‰**:

å®Ÿè£…å ´æ‰€: `functions/src/services/queueService.ts`

```typescript
export class PriorityQueue {
  private queues: {
    high: QueuedRequest[];
    normal: QueuedRequest[];
    low: QueuedRequest[];
  };

  async enqueue(
    request: ClaudeAPIRequest,
    priority: 'high' | 'normal' | 'low' = 'normal'
  ): Promise<ClaudeAPIResponse> {
    this.queues[priority].push({
      request,
      timestamp: Date.now(),
      retries: 0,
    });

    return this.process();
  }

  private async process(): Promise<ClaudeAPIResponse> {
    // å„ªå…ˆåº¦é †ã«å‡¦ç†
    const request =
      this.queues.high.shift() ||
      this.queues.normal.shift() ||
      this.queues.low.shift();

    if (!request) {
      throw new Error('Queue is empty');
    }

    // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
    await this.waitForRateLimit();

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œ
    try {
      return await callClaudeAPI(request.request);
    } catch (error) {
      if (isRateLimitError(error) && request.retries < 3) {
        // ãƒªãƒˆãƒ©ã‚¤ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
        request.retries++;
        this.queues.low.push(request);
        await sleep(2000 * Math.pow(2, request.retries));
        return this.process();
      }
      throw error;
    }
  }
}
```

**åŠ¹æœ**:
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼: 100% â†’ 0%
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“: ã‚¨ãƒ©ãƒ¼ â†’ å¾…æ©Ÿæ™‚é–“è¡¨ç¤º
- ã‚³ã‚¹ãƒˆ: è¿½åŠ ãªã—

**2. Tier 3ã¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼ˆ100ãƒ¦ãƒ¼ã‚¶ãƒ¼æ™‚å¿…é ˆï¼‰**:

| é …ç›® | Tier 2 | Tier 3 | æ”¹å–„å€ç‡ |
|------|--------|--------|---------|
| RPM | 50 | 1,000 | 20x |
| TPM | 40,000 | 80,000 | 2x |
| RPD | 50,000 | 300,000 | 6x |

**ç”³è«‹æ¡ä»¶**:
- æœˆé–“åˆ©ç”¨é¡: $1,000ä»¥ä¸Š
- 50ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ°é”æ™‚ç‚¹ã§ç”³è«‹é–‹å§‹

**3. è¤‡æ•°APIã‚­ãƒ¼ã«ã‚ˆã‚‹è² è·åˆ†æ•£ï¼ˆç·Šæ€¥å¯¾å¿œï¼‰**:

```typescript
const CLAUDE_API_KEYS = [
  process.env.ANTHROPIC_API_KEY_1,
  process.env.ANTHROPIC_API_KEY_2,
  process.env.ANTHROPIC_API_KEY_3,
];

let currentKeyIndex = 0;

function getNextAPIKey(): string {
  currentKeyIndex = (currentKeyIndex + 1) % CLAUDE_API_KEYS.length;
  return CLAUDE_API_KEYS[currentKeyIndex];
}
```

**åŠ¹æœ**: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’3å€ã«æ‹¡å¤§ï¼ˆç·Šæ€¥æ™‚ã®ã¿ä½¿ç”¨ï¼‰

---

### ãƒœãƒˆãƒ«ãƒãƒƒã‚¯2: Cloud Functions åŒæ™‚å®Ÿè¡Œåˆ¶é™

#### å•é¡Œ

**ç¾åœ¨ã®è¨­å®š**:
- `processChat`: maxInstances = 10
- ãƒ”ãƒ¼ã‚¯æ™‚åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: 5ï¼ˆ50%ä½¿ç”¨ï¼‰

**50ãƒ¦ãƒ¼ã‚¶ãƒ¼æ™‚**:
- ãƒ”ãƒ¼ã‚¯æ™‚åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: 25
- 10ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã¯ä¸è¶³ âš ï¸

**100ãƒ¦ãƒ¼ã‚¶ãƒ¼æ™‚**:
- ãƒ”ãƒ¼ã‚¯æ™‚åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: 50
- æ·±åˆ»ãªãƒœãƒˆãƒ«ãƒãƒƒã‚¯

#### å½±éŸ¿åº¦

- **å„ªå…ˆåº¦**: ğŸŸ  High
- **ç™ºç”Ÿç¢ºç‡**: 50ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§é«˜ç¢ºç‡
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼å½±éŸ¿**: ãƒ¬ã‚¹ãƒãƒ³ã‚¹é…å»¶ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

#### å¯¾ç­–

**1. maxInstancesã®æ®µéšçš„å¢—åŠ **:

| ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•° | processChat | vectorSearch | processFileUpload |
|----------|------------|--------------|------------------|
| 10 | 10 | 10 | 5 |
| 50 | 30 â¬†ï¸ | 50 â¬†ï¸ | 15 â¬†ï¸ |
| 100 | 60 â¬†ï¸ | 100 â¬†ï¸ | 30 â¬†ï¸ |

**å®Ÿè£…**:
```typescript
// functions/src/index.ts
const MAX_INSTANCES = {
  processChat: parseInt(process.env.MAX_INSTANCES_CHAT || '10'),
  vectorSearch: parseInt(process.env.MAX_INSTANCES_SEARCH || '10'),
  processFileUpload: parseInt(process.env.MAX_INSTANCES_UPLOAD || '5'),
};

export const processChat = functions
  .runWith({
    memory: '1GB',
    timeoutSeconds: 300,
    maxInstances: MAX_INSTANCES.processChat,
    minInstances: Math.min(2, MAX_INSTANCES.processChat / 10),
  })
  .https.onCall(async (data, context) => {
    // ...
  });
```

**2. minInstancesã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆå¯¾ç­–**:

**åŠ¹æœ**:
- ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚é–“: 3-5ç§’ â†’ 0ç§’
- P95ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: 20ç§’ â†’ 15ç§’
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦å‘ä¸Š

**ã‚³ã‚¹ãƒˆ**: $20/æœˆï¼ˆminInstances=2ã§2é–¢æ•°ï¼‰

**3. ä¸¦è¡Œå‡¦ç†ã®æœ€é©åŒ–**:

```typescript
// éåŠ¹ç‡ãªç›´åˆ—å‡¦ç†
const knowledge = await searchKnowledge(query);
const embedding = await generateEmbedding(text);
const response = await callClaude(message);

// æœ€é©åŒ–: ä¸¦è¡Œå‡¦ç†
const [knowledge, embedding] = await Promise.all([
  searchKnowledge(query),
  generateEmbedding(text),
]);
const response = await callClaude(message, knowledge);
```

**åŠ¹æœ**:
- å‡¦ç†æ™‚é–“: 30ç§’ â†’ 20ç§’ï¼ˆ33%çŸ­ç¸®ï¼‰
- åŒæ™‚å®Ÿè¡Œæ•°: 20%å‰Šæ¸›

---

### ãƒœãƒˆãƒ«ãƒãƒƒã‚¯3: Firestore èª­ã¿å–ã‚Šã‚³ã‚¹ãƒˆ

#### å•é¡Œ

**äºˆæ¸¬ã‚³ã‚¹ãƒˆå¢—åŠ **:

| ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•° | æœˆé–“èª­ã¿å–ã‚Š | ã‚³ã‚¹ãƒˆ | ãƒ¦ãƒ¼ã‚¶ãƒ¼å˜ä¾¡ |
|----------|------------|--------|------------|
| 10 | 500,000 | $0.18 | $0.018 |
| 50 | 2,500,000 | $0.90 | $0.018 |
| 100 | 5,000,000 | $1.80 | $0.018 |

**å•é¡Œç‚¹**:
- èª­ã¿å–ã‚Šå›æ•°ãŒç·šå½¢å¢—åŠ 
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ã§ã¯10å€ã®ã‚³ã‚¹ãƒˆ

#### å½±éŸ¿åº¦

- **å„ªå…ˆåº¦**: ğŸŸ¡ Medium
- **ç™ºç”Ÿç¢ºç‡**: ç¢ºå®Ÿã«ç™ºç”Ÿ
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼å½±éŸ¿**: ãªã—ï¼ˆã‚³ã‚¹ãƒˆã®ã¿ï¼‰

#### å¯¾ç­–

**1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ï¼ˆReact Queryï¼‰**:

```typescript
// hooks/useProject.ts
import { useQuery } from '@tanstack/react-query';

export function useProject(projectId: string) {
  return useQuery({
    queryKey: ['project', projectId],
    queryFn: () => getProject(projectId),
    staleTime: 5 * 60 * 1000,      // 5åˆ†é–“æ–°é®®
    cacheTime: 30 * 60 * 1000,     // 30åˆ†é–“ä¿æŒ
    refetchOnWindowFocus: false,   // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚å†å–å¾—ãªã—
  });
}
```

**åŠ¹æœ**:
- èª­ã¿å–ã‚Šå‰Šæ¸›: 70%
- 5,000,000 â†’ 1,500,000èª­ã¿å–ã‚Š
- ã‚³ã‚¹ãƒˆå‰Šæ¸›: $1.80 â†’ $0.54/æœˆ

**2. Firestoreãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥**:

```typescript
// config/firebase.ts
import { initializeFirestore, persistentLocalCache } from 'firebase/firestore';

export const db = initializeFirestore(app, {
  localCache: persistentLocalCache({
    tabManager: persistentMultipleTabManager(),
  }),
});
```

**åŠ¹æœ**:
- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ
- è¿½åŠ ã§30%ã®èª­ã¿å–ã‚Šå‰Šæ¸›
- ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰é«˜é€ŸåŒ–

**3. ãƒãƒƒãƒèª­ã¿å–ã‚Šã®å¾¹åº•**:

```typescript
// utils/firestoreHelpers.ts
export async function batchGetDocs<T>(
  db: Firestore,
  collection: string,
  ids: string[]
): Promise<Map<string, T>> {
  // æœ€å¤§10ä»¶ãšã¤ãƒãƒƒãƒå–å¾—
  const chunks = chunkArray(ids, 10);

  const results = await Promise.all(
    chunks.map(chunk =>
      getDocs(
        query(
          collection(db, collection),
          where(documentId(), 'in', chunk)
        )
      )
    )
  );

  const map = new Map<string, T>();
  results.forEach(snapshot => {
    snapshot.docs.forEach(doc => {
      map.set(doc.id, doc.data() as T);
    });
  });

  return map;
}
```

**åŠ¹æœ**:
- N+1ã‚¯ã‚¨ãƒªè§£æ¶ˆ
- èª­ã¿å–ã‚Šå›æ•°: 80%å‰Šæ¸›

**ç·åˆåŠ¹æœ**:
- èª­ã¿å–ã‚Šã‚³ã‚¹ãƒˆ: $1.80 â†’ $0.36/æœˆï¼ˆ80%å‰Šæ¸›ï¼‰

---

### ãƒœãƒˆãƒ«ãƒãƒƒã‚¯4: Vector Search ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

#### å•é¡Œ

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚ºå¢—åŠ **:

| ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•° | ãƒŠãƒ¬ãƒƒã‚¸ä»¶æ•° | Embeddingæ•° | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚º | æ¤œç´¢æ™‚é–“ |
|----------|------------|------------|-----------------|---------|
| 10 | 10,000 | 50,000 | 200MB | 100ms |
| 50 | 50,000 | 250,000 | 1GB | 300ms |
| 100 | 100,000 | 500,000 | 2GB | 600ms âš ï¸ |

**å•é¡Œç‚¹**:
- æ¤œç´¢æ™‚é–“ãŒç·šå½¢å¢—åŠ 
- 600msã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã«æ‚ªå½±éŸ¿

#### å½±éŸ¿åº¦

- **å„ªå…ˆåº¦**: ğŸŸ¡ Medium
- **ç™ºç”Ÿç¢ºç‡**: 100ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ç¢ºå®Ÿã«ç™ºç”Ÿ
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼å½±éŸ¿**: æ¤œç´¢é…å»¶

#### å¯¾ç­–

**1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åˆ†å‰²**:

```typescript
// ç¾åœ¨: å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¸€æ‹¬æ¤œç´¢
const allKnowledge = await db.collection('knowledge').get();

// æœ€é©åŒ–: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã«æ¤œç´¢
const projectKnowledge = await db
  .collection('knowledge')
  .where('projectId', '==', projectId)
  .get();
```

**åŠ¹æœ**:
- æ¤œç´¢å¯¾è±¡: 100,000ä»¶ â†’ 500ä»¶ï¼ˆ200åˆ†ã®1ï¼‰
- æ¤œç´¢æ™‚é–“: 600ms â†’ 50msï¼ˆ92%çŸ­ç¸®ï¼‰

**2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°**:

```typescript
// Firestoreã®ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ´»ç”¨
// projects/{projectId}/knowledge/{knowledgeId}

async function searchProjectKnowledge(
  projectId: string,
  queryEmbedding: number[]
): Promise<SearchResult[]> {
  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢
  const snapshot = await db
    .collection('projects')
    .doc(projectId)
    .collection('knowledge')
    .where('embedding', '!=', null)
    .limit(1000)
    .get();

  // ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦è¨ˆç®—
  return calculateSimilarities(snapshot, queryEmbedding);
}
```

**åŠ¹æœ**:
- æ¤œç´¢ç¯„å›²ã®é™å®š
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡ã®å‘ä¸Š
- æ¤œç´¢æ™‚é–“: 50%å‰Šæ¸›

**3. å¤ã„ãƒŠãƒ¬ãƒƒã‚¸ã®è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–**:

```typescript
// 6ãƒ¶æœˆä»¥ä¸Šã‚¢ã‚¯ã‚»ã‚¹ãŒãªã„ãƒŠãƒ¬ãƒƒã‚¸ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
export const archiveOldKnowledge = onSchedule('every 7 days', async () => {
  const sixMonthsAgo = new Date();
  sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);

  const oldKnowledge = await db
    .collection('knowledge')
    .where('lastAccessedAt', '<', sixMonthsAgo)
    .where('isArchived', '==', false)
    .limit(1000)
    .get();

  const batch = db.batch();
  oldKnowledge.docs.forEach(doc => {
    // Embeddingã‚’å‰Šé™¤ã—ã¦ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å‰Šæ¸›
    batch.update(doc.ref, {
      isArchived: true,
      embedding: admin.firestore.FieldValue.delete(),
    });
  });

  await batch.commit();
});
```

**åŠ¹æœ**:
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚º: 30%å‰Šæ¸›
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆ: 20%å‰Šæ¸›
- æ¤œç´¢é€Ÿåº¦: 40%å‘ä¸Š

**4. å°‚ç”¨Vector DBã¸ã®ç§»è¡Œæ¤œè¨ï¼ˆå°†æ¥ï¼‰**:

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³**:
- **Pinecone**: ãƒ•ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ‰Vector DB
- **Weaviate**: ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹Vector DB
- **Qdrant**: é«˜æ€§èƒ½Vectoræ¤œç´¢

**ç§»è¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°**:
- 100ä¸‡ä»¶ã®ãƒŠãƒ¬ãƒƒã‚¸åˆ°é”æ™‚
- æ¤œç´¢æ™‚é–“ãŒ1ç§’ã‚’è¶…ãˆã‚‹å ´åˆ

**ã‚³ã‚¹ãƒˆæ¯”è¼ƒ**:

| ã‚µãƒ¼ãƒ“ã‚¹ | æœˆé¡ã‚³ã‚¹ãƒˆ | æ¤œç´¢é€Ÿåº¦ | ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ |
|---------|----------|---------|---------------|
| Firestoreï¼ˆç¾åœ¨ï¼‰ | $2/æœˆ | 300-600ms | ä¸­ |
| Pinecone Starter | $70/æœˆ | 50-100ms | é«˜ |
| Weaviate (è‡ªå·±ãƒ›ã‚¹ãƒˆ) | $30/æœˆ | 100-200ms | é«˜ |

**æ¨å¥¨**: 100ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ°é”å¾Œã«æ¤œè¨

---

## å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º

### Phase 2 æº–å‚™ï¼ˆ0-10ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ 50ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰

#### Week 1-2: ã‚¤ãƒ³ãƒ•ãƒ©å¼·åŒ–

**ã‚¿ã‚¹ã‚¯**:
- [x] Cloud Functions maxInstances èª¿æ•´
  - `processChat`: 10 â†’ 30
  - `vectorSearch`: 10 â†’ 50
  - `processFileUpload`: 5 â†’ 15

- [x] minInstances å°å…¥ï¼ˆã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆå¯¾ç­–ï¼‰
  - `processChat`: minInstances = 2
  - `vectorSearch`: minInstances = 2

- [x] Firestoreè¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
  - chats: projectId + userId + createdAt
  - knowledge: projectId + category + embedding

**æ¤œè¨¼æ–¹æ³•**:
```bash
# Load testing with Apache Bench
ab -n 1000 -c 50 https://your-project.web.app/api/processChat
```

#### Week 3-4: ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æœ€é©åŒ–

**ã‚¿ã‚¹ã‚¯**:
- [ ] React Queryå°å…¥
  ```bash
  npm install @tanstack/react-query
  ```

- [ ] Firestoreãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹åŒ–
  ```typescript
  // config/firebase.ts
  import { persistentLocalCache } from 'firebase/firestore';
  ```

- [ ] ãƒãƒƒãƒèª­ã¿å–ã‚Šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£å®Ÿè£…
  ```typescript
  // utils/firestoreHelpers.ts
  export async function batchGetDocs<T>(...)
  ```

**ç›®æ¨™**:
- Firestoreèª­ã¿å–ã‚Šå‰Šæ¸›: 70%
- ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚é–“çŸ­ç¸®: 50%

#### Week 5-6: Claude API ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–

**ã‚¿ã‚¹ã‚¯**:
- [ ] ã‚­ãƒ¥ãƒ¼åˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…
  ```typescript
  // functions/src/services/queueService.ts
  export class ClaudeRequestQueue { ... }
  ```

- [ ] ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
  ```typescript
  // functions/src/monitoring/rateLimitMonitor.ts
  export async function logRateLimitStatus() { ... }
  ```

- [ ] Tier 3ç”³è«‹æº–å‚™
  - åˆ©ç”¨å®Ÿç¸¾ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
  - Anthropic ã‚µãƒãƒ¼ãƒˆã«é€£çµ¡

**æ¤œè¨¼æ–¹æ³•**:
```typescript
// ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
for (let i = 0; i < 100; i++) {
  await callClaudeAPI(testRequest);
}
// ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã“ã¨ã‚’ç¢ºèª
```

#### Week 7-8: Vector Search æœ€é©åŒ–

**ã‚¿ã‚¹ã‚¯**:
- [ ] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åˆ†å‰²
  ```typescript
  // functions/src/services/vectorSearchService.ts
  async function searchInPartition(projectId, ...)
  ```

- [ ] å¤ã„ãƒŠãƒ¬ãƒƒã‚¸ã®è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
  ```typescript
  // functions/src/scheduledArchiveOldKnowledge.ts
  export const archiveOldKnowledge = onSchedule(...)
  ```

**ç›®æ¨™**:
- æ¤œç´¢æ™‚é–“çŸ­ç¸®: 60%
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚ºå‰Šæ¸›: 30%

---

### Phase 3 æº–å‚™ï¼ˆ50ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ 100ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰

#### Month 1: ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æ¤œè¨¼

**ã‚¿ã‚¹ã‚¯**:
- [ ] Claude API Tier 3 æ‰¿èªå¾…ã¡
- [ ] maxInstances 60ã«å¢—åŠ 
- [ ] ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆå®Ÿæ–½
  ```bash
  # 100åŒæ™‚æ¥ç¶šã§ãƒ†ã‚¹ãƒˆ
  ab -n 10000 -c 100 https://your-project.web.app/api/processChat
  ```

#### Month 2: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

**ã‚¿ã‚¹ã‚¯**:
- [ ] ä¸¦è¡Œå‡¦ç†ã®å¾¹åº•
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–
- [ ] CDNã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ´»ç”¨

#### Month 3: ã‚³ã‚¹ãƒˆæœ€é©åŒ–

**ã‚¿ã‚¹ã‚¯**:
- [ ] ä¸è¦ãªCloud Functionå‰Šé™¤
- [ ] ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«è¨­å®š
- [ ] ãƒ­ã‚°ä¿æŒæœŸé–“ã®æœ€é©åŒ–

---

## ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æˆ¦ç•¥

### é‡è¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹

#### 1. Claude APIä½¿ç”¨çŠ¶æ³

**ç›£è¦–é …ç›®**:
```typescript
interface ClaudeMetrics {
  // ãƒ¬ãƒ¼ãƒˆåˆ¶é™
  currentRPM: number;        // ç¾åœ¨ã®RPM
  maxRPM: number;            // åˆ¶é™å€¤
  utilizationPercent: number; // ä½¿ç”¨ç‡

  // ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡
  inputTokens: number;
  cacheReadTokens: number;
  outputTokens: number;

  // ã‚³ã‚¹ãƒˆ
  hourlyCoat: number;
  dailyCost: number;
  monthlyCost: number;

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡
  cacheHitRate: number;
  costSavings: number;
}
```

**ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š**:
```typescript
// functions/src/monitoring/alerts.ts
export async function checkClaudeAPIUsage() {
  const metrics = await getClaudeMetrics();

  // RPMä½¿ç”¨ç‡80%ä»¥ä¸Šã§è­¦å‘Š
  if (metrics.utilizationPercent > 80) {
    await sendAlert({
      severity: 'warning',
      title: 'Claude APIä½¿ç”¨ç‡ãŒé«˜ã„',
      message: `ç¾åœ¨ã®RPM: ${metrics.currentRPM}/${metrics.maxRPM} (${metrics.utilizationPercent}%)`,
      action: 'ã‚­ãƒ¥ãƒ¼åˆ¶å¾¡ã®å¼·åŒ–ã¾ãŸã¯Tier 3ã¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’æ¤œè¨',
    });
  }

  // æ—¥æ¬¡ã‚³ã‚¹ãƒˆãŒäºˆç®—ã®120%ã‚’è¶…ãˆãŸã‚‰è­¦å‘Š
  const dailyBudget = 40; // $40/æ—¥
  if (metrics.dailyCost > dailyBudget * 1.2) {
    await sendAlert({
      severity: 'critical',
      title: 'æ—¥æ¬¡ã‚³ã‚¹ãƒˆäºˆç®—è¶…é',
      message: `æœ¬æ—¥ã®ã‚³ã‚¹ãƒˆ: $${metrics.dailyCost} (äºˆç®—: $${dailyBudget})`,
      action: 'ã‚³ã‚¹ãƒˆå‰Šæ¸›ç­–ã®å®Ÿæ–½ãŒå¿…è¦',
    });
  }
}
```

#### 2. Firestore ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

**ç›£è¦–é …ç›®**:
```typescript
interface FirestoreMetrics {
  // èª­ã¿å–ã‚Š/æ›¸ãè¾¼ã¿
  readsPerMinute: number;
  writesPerMinute: number;
  deletesPerMinute: number;

  // ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·
  avgReadLatency: number;
  p95ReadLatency: number;
  avgWriteLatency: number;

  // ã‚³ã‚¹ãƒˆ
  dailyReads: number;
  dailyWrites: number;
  estimatedMonthlyCost: number;

  // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
  totalStorageGB: number;
  storageGrowthRate: number; // GB/æ—¥
}
```

**ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**:
```typescript
// Cloud Functionså®šæœŸå®Ÿè¡Œ
export const firestoreMetricsReport = onSchedule('every 1 hours', async () => {
  const metrics = await getFirestoreMetrics();

  await db.collection('system_metrics').add({
    timestamp: serverTimestamp(),
    type: 'firestore',
    metrics,
  });

  // Slackã«é€šçŸ¥ï¼ˆç•°å¸¸å€¤ã®ã¿ï¼‰
  if (metrics.p95ReadLatency > 1000) { // 1ç§’ä»¥ä¸Š
    await sendSlackNotification({
      channel: '#et-ai-alerts',
      message: `âš ï¸ Firestoreèª­ã¿å–ã‚Šãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒé«˜ã„: ${metrics.p95ReadLatency}ms`,
    });
  }
});
```

#### 3. Cloud Functions ãƒ¡ãƒˆãƒªã‚¯ã‚¹

**ç›£è¦–é …ç›®**:
```typescript
interface CloudFunctionsMetrics {
  // å®Ÿè¡ŒçŠ¶æ³
  totalInvocations: number;
  activeInstances: number;
  maxInstances: number;
  utilizationPercent: number;

  // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
  avgExecutionTime: number;
  p95ExecutionTime: number;
  errorRate: number;
  timeoutRate: number;

  // ã‚³ã‚¹ãƒˆ
  totalExecutionTime: number;    // GB-seconds
  estimatedMonthlyCost: number;
}
```

### è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãƒˆãƒªã‚¬ãƒ¼

```typescript
// functions/src/monitoring/autoScaling.ts

export const autoScaleCheck = onSchedule('every 5 minutes', async () => {
  const metrics = await getCloudFunctionsMetrics();

  // ä½¿ç”¨ç‡ãŒ80%ã‚’è¶…ãˆãŸã‚‰è‡ªå‹•ã§maxInstancesã‚’å¢—ã‚„ã™
  if (metrics.utilizationPercent > 80) {
    const newMaxInstances = Math.min(
      metrics.maxInstances * 1.5,  // 1.5å€ã«å¢—ã‚„ã™
      100                          // æœ€å¤§100
    );

    console.log(`Auto-scaling: ${metrics.maxInstances} â†’ ${newMaxInstances}`);

    // ç’°å¢ƒå¤‰æ•°ã‚’æ›´æ–°ï¼ˆæ¬¡å›ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«åæ˜ ï¼‰
    await updateEnvironmentVariable('MAX_INSTANCES_CHAT', newMaxInstances.toString());

    // ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡
    await sendAlert({
      severity: 'info',
      title: 'Cloud Functions è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°',
      message: `maxInstancesã‚’${metrics.maxInstances}ã‹ã‚‰${newMaxInstances}ã«å¢—åŠ ã—ã¾ã—ãŸ`,
    });
  }
});
```

### ã‚³ã‚¹ãƒˆã‚¢ãƒ©ãƒ¼ãƒˆ

```typescript
// functions/src/monitoring/costAlerts.ts

interface BudgetAlert {
  service: 'claude' | 'firestore' | 'functions';
  dailyBudget: number;
  monthlyBudget: number;
}

const BUDGETS: BudgetAlert[] = [
  { service: 'claude', dailyBudget: 40, monthlyBudget: 1000 },
  { service: 'firestore', dailyBudget: 1, monthlyBudget: 30 },
  { service: 'functions', dailyBudget: 5, monthlyBudget: 150 },
];

export const checkBudgets = onSchedule('every 1 hours', async () => {
  for (const budget of BUDGETS) {
    const currentCost = await getCurrentDailyCost(budget.service);
    const utilizationPercent = (currentCost / budget.dailyBudget) * 100;

    if (utilizationPercent > 80) {
      await sendAlert({
        severity: utilizationPercent > 100 ? 'critical' : 'warning',
        title: `${budget.service} äºˆç®—ã‚¢ãƒ©ãƒ¼ãƒˆ`,
        message: `æœ¬æ—¥ã®ã‚³ã‚¹ãƒˆ: $${currentCost} / $${budget.dailyBudget} (${utilizationPercent.toFixed(1)}%)`,
        action: utilizationPercent > 100 ? 'ç·Šæ€¥å¯¾å¿œãŒå¿…è¦' : 'ç›£è¦–ã‚’ç¶™ç¶š',
      });
    }
  }
});
```

---

## ã¾ã¨ã‚

### ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

```
ç¾åœ¨ï¼ˆ10ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
â”œâ”€â”€ $118/æœˆ
â”œâ”€â”€ å•é¡Œãªãå‹•ä½œ
â””â”€â”€ ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°åŠ¹æœã§33%å‰Šæ¸›

â†“ Phase 2ï¼ˆ2ãƒ¶æœˆï¼‰

50ãƒ¦ãƒ¼ã‚¶ãƒ¼
â”œâ”€â”€ $609/æœˆ
â”œâ”€â”€ ã‚¤ãƒ³ãƒ•ãƒ©å¼·åŒ–å®Œäº†
â”œâ”€â”€ ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æœ€é©åŒ–
â”œâ”€â”€ Claude API Tier 3ç”³è«‹
â””â”€â”€ å®‰å®šç¨¼åƒ

â†“ Phase 3ï¼ˆ3ãƒ¶æœˆï¼‰

100ãƒ¦ãƒ¼ã‚¶ãƒ¼
â”œâ”€â”€ $1,218/æœˆ
â”œâ”€â”€ Claude API Tier 3æ‰¿èª
â”œâ”€â”€ å®Œå…¨è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
â””â”€â”€ ç›®æ¨™é”æˆ ğŸ‰
```

### é‡è¦ãªæˆåŠŸè¦å› 

1. **æ®µéšçš„ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°**: ä¸€æ°—ã«100ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã¯ãªãã€50ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§æ¤œè¨¼
2. **ãƒ—ãƒ­ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå¯¾ç­–**: ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ãŒé¡•åœ¨åŒ–ã™ã‚‹å‰ã«å¯¾å¿œ
3. **ç¶™ç¶šçš„ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°**: 1æ™‚é–“ã”ã¨ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ã¨ã‚¢ãƒ©ãƒ¼ãƒˆ
4. **ã‚³ã‚¹ãƒˆæ„è­˜**: æœˆé–“äºˆç®—$1,500ä»¥å†…ã‚’ç¶­æŒ

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- [ ] Week 1-2: Cloud Functions maxInstances èª¿æ•´
- [ ] Week 3-4: React Query + Firestoreã‚­ãƒ£ãƒƒã‚·ãƒ¥å°å…¥
- [ ] Week 5-6: Claude APIã‚­ãƒ¥ãƒ¼åˆ¶å¾¡å®Ÿè£…
- [ ] Week 7-8: Vector Search æœ€é©åŒ–

---

**ä½œæˆæ—¥**: 2025-01-20
**æœ€çµ‚æ›´æ–°**: 2025-01-20
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0
