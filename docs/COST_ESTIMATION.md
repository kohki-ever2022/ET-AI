# ET-AI ランニングコスト試算

このドキュメントでは、ET-AI アプリケーションの月間ランニングコストを試算します。

## 📊 試算シナリオ

3つの使用規模でコストを試算します：

| 規模 | アクティブユーザー | チャット数/月 | ドキュメント数/月 | 想定用途 |
|------|-------------------|--------------|------------------|----------|
| 🟢 小規模 | 5名 | 500回 | 50件 | スタートアップ、小規模チーム |
| 🟡 中規模 | 20名 | 3,000回 | 200件 | 成長企業、中規模プロジェクト |
| 🔴 大規模 | 50名 | 10,000回 | 500件 | エンタープライズ、大規模展開 |

---

## 💰 コスト内訳

### 1. Cloud Functions（Google Cloud Platform）

#### 1.1 常時稼働インスタンス（minInstances）

常に起動しているインスタンスのコスト：

| 関数 | メモリ | minInstances | 月間コスト（USD） |
|------|--------|--------------|------------------|
| processChat | 1GB | 2 | $21.60 |
| processFileUpload | 2GB | 1 | $21.60 |
| vectorSearch | 512MB | 2 | $10.80 |
| **合計** | - | - | **$54.00** |

**計算式:**
- 1GB インスタンス: $0.000015/秒 × 2インスタンス × 720時間/月 × 3600秒/時間 = $21.60
- 2GB インスタンス: $0.000030/秒 × 1インスタンス × 720時間/月 × 3600秒/時間 = $21.60
- 512MB インスタンス: $0.0000075/秒 × 2インスタンス × 720時間/月 × 3600秒/時間 = $10.80

#### 1.2 実行時コスト

| シナリオ | チャット処理 | ファイル処理 | ベクトル検索 | スケジュール | 合計 |
|---------|------------|------------|------------|-------------|------|
| 🟢 小規模 | $4.17 | $10.00 | $0.33 | $1.80 | **$16.30** |
| 🟡 中規模 | $25.00 | $40.00 | $2.00 | $1.80 | **$68.80** |
| 🔴 大規模 | $83.33 | $100.00 | $6.67 | $1.80 | **$191.80** |

**計算の前提:**
- **processChat (1GB, 平均30秒):**
  - 小規模: 500回 × 30秒 × $0.000025/GB-秒 × 1GB = $4.17
  - 中規模: 3,000回 × 30秒 × $0.000025/GB-秒 × 1GB = $25.00
  - 大規模: 10,000回 × 30秒 × $0.000025/GB-秒 × 1GB = $83.33

- **processFileUpload (2GB, 平均120秒):**
  - 小規模: 50回 × 120秒 × $0.000050/GB-秒 × 2GB = $10.00
  - 中規模: 200回 × 120秒 × $0.000050/GB-秒 × 2GB = $40.00
  - 大規模: 500回 × 120秒 × $0.000050/GB-秒 × 2GB = $100.00

- **vectorSearch (512MB, 平均5秒):**
  - 小規模: 500回 × 5秒 × $0.0000125/GB-秒 × 0.5GB = $0.33
  - 中規模: 3,000回 × 5秒 × $0.0000125/GB-秒 × 0.5GB = $2.00
  - 大規模: 10,000回 × 5秒 × $0.0000125/GB-秒 × 0.5GB = $6.67

- **スケジュール関数 (256MB, 平均10秒):**
  - monitorRateLimits: 43,200回/月
  - scheduledHealthCheck: 8,640回/月
  - checkBudgets: 720回/月
  - その他daily: 100回/月
  - 合計: 52,660回 × 10秒 × $0.000025/GB-秒 × 0.25GB = $1.80

#### 1.3 Cloud Functions 合計コスト

| シナリオ | 常時稼働 | 実行時 | **合計** |
|---------|---------|--------|---------|
| 🟢 小規模 | $54.00 | $16.30 | **$70.30** |
| 🟡 中規模 | $54.00 | $68.80 | **$122.80** |
| 🔴 大規模 | $54.00 | $191.80 | **$245.80** |

---

### 2. Firestore（Google Cloud Platform）

#### 2.1 読み取り・書き込みコスト

| シナリオ | 読み取り数 | 書き込み数 | 読み取りコスト | 書き込みコスト | 合計 |
|---------|-----------|-----------|--------------|--------------|------|
| 🟢 小規模 | 10,000 | 1,500 | $0.04 | $0.54 | **$0.58** |
| 🟡 中規模 | 60,000 | 6,000 | $0.24 | $2.16 | **$2.40** |
| 🔴 大規模 | 200,000 | 15,000 | $0.80 | $5.40 | **$6.20** |

**計算の前提:**
- 読み取り: $0.06 / 100,000ドキュメント（無料枠50,000を超えた分）
- 書き込み: $0.18 / 100,000ドキュメント（無料枠20,000を超えた分）

**読み取り内訳（チャットあたり）:**
- プロジェクト情報: 1回
- チャンネル情報: 1回
- knowledge検索: 5回（平均）
- ユーザー情報: 1回
- その他（トリガー、キュー管理）: 12回
- **合計: 約20回/チャット**

**書き込み内訳（チャットあたり）:**
- チャット保存: 1回
- ステータス更新: 2回
- **合計: 約3回/チャット**

**ドキュメント処理あたり:**
- 読み取り: 5回
- 書き込み: 20回（平均20チャンクの場合）

#### 2.2 ストレージコスト

| シナリオ | データ量 | 月間コスト |
|---------|---------|-----------|
| 🟢 小規模 | 100 MB | **$0.02** |
| 🟡 中規模 | 500 MB | **$0.10** |
| 🔴 大規模 | 2 GB | **$0.38** |

**計算:**
- $0.18 / GB / 月（無料枠1GBを超えた分のみ）

**データ内訳:**
- チャット履歴: 平均5KB/チャット
- knowledge: 平均10KB/ドキュメント
- ユーザー・プロジェクト情報: 50KB
- メタデータ: 100KB

#### 2.3 Firestore 合計コスト

| シナリオ | 読み書き | ストレージ | **合計** |
|---------|---------|-----------|---------|
| 🟢 小規模 | $0.58 | $0.02 | **$0.60** |
| 🟡 中規模 | $2.40 | $0.10 | **$2.50** |
| 🔴 大規模 | $6.20 | $0.38 | **$6.58** |

---

### 3. Cloud Storage（Google Cloud Platform）

#### 3.1 ストレージコスト

| シナリオ | ファイル数 | 平均サイズ | 合計容量 | 月間コスト |
|---------|-----------|----------|---------|-----------|
| 🟢 小規模 | 50 | 2 MB | 100 MB | **$0.00** |
| 🟡 中規模 | 200 | 2 MB | 400 MB | **$0.01** |
| 🔴 大規模 | 500 | 2 MB | 1 GB | **$0.02** |

**計算:**
- $0.020 / GB / 月（Standard Storage）

#### 3.2 ネットワークコスト

| シナリオ | ダウンロード回数 | 合計転送量 | 月間コスト |
|---------|----------------|-----------|-----------|
| 🟢 小規模 | 100回 | 200 MB | **$0.00** |
| 🟡 中規模 | 400回 | 800 MB | **$0.00** |
| 🔴 大規模 | 1,000回 | 2 GB | **$0.00** |

**計算:**
- 無料枠: 1 GB / 日（月間30GB）→ すべてのシナリオで無料枠内

#### 3.3 Cloud Storage 合計コスト

| シナリオ | ストレージ | ネットワーク | **合計** |
|---------|-----------|------------|---------|
| 🟢 小規模 | $0.00 | $0.00 | **$0.00** |
| 🟡 中規模 | $0.01 | $0.00 | **$0.01** |
| 🔴 大規模 | $0.02 | $0.00 | **$0.02** |

---

### 4. Claude API（Anthropic）

#### 4.1 トークン使用量の前提

**チャット処理あたり:**
- Input tokens（平均）: 5,000トークン
  - システムプロンプト: 2,000トークン
  - knowledge（RAG）: 2,500トークン（平均5件 × 500トークン）
  - ユーザーメッセージ: 500トークン
- Output tokens（平均）: 1,000トークン

**Prompt Caching（キャッシュ効率）:**
- Cache hit rate: 80%（システムプロンプトとknowledgeがキャッシュされる）
- キャッシュされた2,500トークンは通常の90%割引

#### 4.2 Claude API コスト（claude-sonnet-4-20250514）

**価格（2025年5月時点）:**
- Input tokens: $3.00 / 1M tokens
- Cache writes: $3.75 / 1M tokens
- Cache reads: $0.30 / 1M tokens（90% off）
- Output tokens: $15.00 / 1M tokens

| シナリオ | Input | Cache Writes | Cache Reads | Output | **合計** |
|---------|-------|-------------|------------|--------|---------|
| 🟢 小規模 | $3.75 | $0.94 | $0.30 | $7.50 | **$12.49** |
| 🟡 中規模 | $22.50 | $5.63 | $1.80 | $45.00 | **$74.93** |
| 🔴 大規模 | $75.00 | $18.75 | $6.00 | $150.00 | **$249.75** |

**計算例（中規模）:**
- Input tokens (non-cached): 3,000回 × 2,500トークン = 7.5M tokens → $22.50
- Cache writes (初回): 3,000回 × 2,500トークン × 20% = 1.5M tokens → $5.63
- Cache reads (2回目以降): 3,000回 × 2,500トークン × 80% = 6M tokens → $1.80
- Output tokens: 3,000回 × 1,000トークン = 3M tokens → $45.00

---

### 5. Voyage AI API（埋め込み生成）

#### 5.1 使用量の前提

**ドキュメント処理:**
- 平均チャンク数: 20チャンク/ドキュメント
- 平均トークン数: 500トークン/チャンク

**ベクトル検索（クエリ）:**
- チャットごとに1回のクエリ埋め込み生成
- 平均トークン数: 50トークン/クエリ

#### 5.2 Voyage AI コスト（voyage-large-2）

**価格:**
- $0.12 / 1M tokens

| シナリオ | ドキュメント処理 | クエリ処理 | **合計** |
|---------|----------------|-----------|---------|
| 🟢 小規模 | $0.60 | $0.003 | **$0.60** |
| 🟡 中規模 | $2.40 | $0.018 | **$2.42** |
| 🔴 大規模 | $6.00 | $0.060 | **$6.06** |

**計算例（中規模）:**
- ドキュメント処理: 200件 × 20チャンク × 500トークン = 2M tokens → $2.40
- クエリ処理: 3,000回 × 50トークン = 0.15M tokens → $0.018

---

## 📈 総コスト試算

### 月間ランニングコスト合計

| サービス | 🟢 小規模 | 🟡 中規模 | 🔴 大規模 |
|---------|---------|---------|---------|
| **Cloud Functions** | $70.30 | $122.80 | $245.80 |
| **Firestore** | $0.60 | $2.50 | $6.58 |
| **Cloud Storage** | $0.00 | $0.01 | $0.02 |
| **Claude API** | $12.49 | $74.93 | $249.75 |
| **Voyage AI** | $0.60 | $2.42 | $6.06 |
| **月間合計（USD）** | **$83.99** | **$202.66** | **$508.21** |
| **月間合計（JPY）** | **¥12,599** | **¥30,399** | **¥76,232** |

*為替レート: 1 USD = 150 JPY で計算

---

## 💡 コスト最適化のポイント

### 1. 🔥 高コスト要因（優先度順）

1. **Cloud Functions の常時稼働インスタンス（$54/月）**
   - minInstances を 0 にすれば削減可能
   - ただしコールドスタート（初回起動遅延）が発生

2. **Claude API（大規模: $249.75/月）**
   - 最も高額なコスト要因
   - Prompt Caching で既に80%削減済み

3. **Cloud Functions の実行時コスト（大規模: $191.80/月）**
   - ファイル処理が最も高額（2GB × 120秒）

### 2. ✅ 実装済みのコスト最適化

- ✅ **Prompt Caching（3層）**: Claude APIコストを約80%削減
- ✅ **React Query キャッシュ**: Firestoreの読み取り削減
- ✅ **非正規化**: データの読み取り回数を削減
- ✅ **アーカイブシステム**: 90日以上の古いデータを削減
- ✅ **重複排除**: knowledge の重複保存を防止
- ✅ **バッチ処理**: Voyage AI の効率的な埋め込み生成

### 3. 🎯 今後検討できる最適化

#### オプション A: minInstances を削減（コスト重視）
- **削減額: $54/月（全体の30-60%）**
- デメリット: コールドスタート（初回レスポンス +2〜5秒）
- 推奨: 小規模・中規模の場合のみ

#### オプション B: Claude API の使用量削減
- knowledge の取得件数を減らす（5件 → 3件）
- システムプロンプトを簡素化
- **削減見込み: 10-20%**

#### オプション C: ファイル処理の最適化
- メモリを 2GB → 1GB に削減（処理時間が増える可能性）
- バッチ処理で複数ファイルをまとめて処理
- **削減見込み: 20-30%**

#### オプション D: スケジュール関数の頻度調整
- monitorRateLimits: 1分 → 5分
- scheduledHealthCheck: 5分 → 15分
- **削減見込み: $1.50/月（わずか）**

---

## 📊 シナリオ別の推奨プラン

### 🟢 小規模（$84/月、¥12,600/月）

**適用:**
- スタートアップの検証フェーズ
- 小規模チーム（5名以下）
- 低頻度利用（月500チャット未満）

**最適化案:**
- minInstances を 0 に設定 → **$30/月（¥4,500）に削減可能**
- Firestore の読み取りを React Query でキャッシュ（実装済み）

### 🟡 中規模（$203/月、¥30,400/月）

**適用:**
- 成長企業の本格運用
- 中規模チーム（20名前後）
- 通常利用（月3,000チャット）

**最適化案:**
- そのまま運用推奨（最適化済み）
- Claude API のキャッシュ効率が高い

### 🔴 大規模（$508/月、¥76,200/月）

**適用:**
- エンタープライズ展開
- 大規模チーム（50名以上）
- ヘビー利用（月10,000チャット）

**最適化案:**
- Claude API の使用量を精査
- knowledge 取得件数の調整検討
- ファイル処理の最適化

---

## ⚠️ 重要な注意事項

### 1. 無料枠について

以下の無料枠は試算に含まれています：
- **Cloud Functions**: 200万回/月の呼び出し、40万GB-秒/月
- **Firestore**: 読み取り 50,000/日、書き込み 20,000/日、削除 20,000/日、ストレージ 1GB
- **Cloud Storage**: ネットワーク転送 1GB/日

### 2. 変動要因

実際のコストは以下の要因で変動します：
- **チャットの長さ**: トークン数が増えるとClaude APIコストが増加
- **knowledge の件数**: RAGで取得するknowledgeが多いとコスト増
- **ファイルサイズ**: 大きなPDFは処理時間が長くなる
- **ドキュメントのチャンク数**: チャンクが多いとVoyage AIコストが増加

### 3. 予算設定の推奨

実際の運用では、試算の **120-150%** を予算として確保することを推奨します：

| シナリオ | 試算コスト | 推奨予算（150%） |
|---------|-----------|----------------|
| 🟢 小規模 | ¥12,600 | **¥19,000** |
| 🟡 中規模 | ¥30,400 | **¥45,000** |
| 🔴 大規模 | ¥76,200 | **¥115,000** |

---

## 📞 コスト監視とアラート

実装済みのコスト監視機能：

1. **予算アラート（checkBudgets）**: 1時間ごとに予算をチェック
2. **日次コストレポート**: 毎日9AMにレポート生成
3. **コストダッシュボード**: リアルタイムでコスト確認可能

これらの機能を活用して、予期しないコスト増加を早期に検知できます。

---

## 🎯 まとめ

### コスト概算（月額）

| 規模 | 月額コスト | 1チャットあたり | 1ユーザーあたり |
|------|-----------|---------------|----------------|
| 🟢 小規模 | **¥12,600** | ¥25 | ¥2,520 |
| 🟡 中規模 | **¥30,400** | ¥10 | ¥1,520 |
| 🔴 大規模 | **¥76,200** | ¥8 | ¥1,524 |

### 主なコスト要因（大規模の場合）

```
Claude API (49%) ████████████████████████████████████████████████░░
Cloud Functions (48%) ███████████████████████████████████████████████░░░
Firestore (1%) █░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
Voyage AI (1%) █░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
Cloud Storage (0%) ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
```

**結論:** ET-AI は中規模利用（20名、月3,000チャット）で月額 **約3万円** で運用可能です。Prompt Caching や React Query キャッシュなどの最適化により、コストを大幅に削減しています。
